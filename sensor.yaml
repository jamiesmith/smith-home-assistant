#Forecast.io weather sensors

  - platform: time_date
    display_options:
      - 'time'
      - 'date'
      - 'date_time'
      - 'time_date'
      - 'time_utc'
      - 'beat'

  - platform: darksky
    api_key: !secret darksky_key
    units: auto
    update_interval:
      minutes: 3
    forecast:
      - 1
      - 2
      - 3
      - 4
      - 5
      - 6                                          
    monitored_conditions:
      - apparent_temperature
      - apparent_temperature_max
      - apparent_temperature_min
      - cloud_cover
      - daily_summary
      - dew_point
      - hourly_summary
      - humidity
      - icon
      - minutely_summary
      - ozone
      - precip_intensity
      - precip_intensity_max
      - precip_probability
      - precip_type
      - pressure
      - summary
      - temperature
      - temperature_max
      - temperature_min
      - visibility
      - wind_bearing
      - wind_speed
      
  - platform: template
    sensors: 
      dark_outside:
        friendly_name: 'Dark Outside'
        value_template: >-
          {% if (states.input_boolean.sunset_offset.state == 'on') %}
          true
          {% elif (states.sun.sun.attributes.elevation | int < 3) %}
          true
          {% elif ( (states.sun.sun.attributes.elevation | int < 4.5) and (states.sensor.dark_sky_cloud_coverage.state | int > 80)) %}
          true
          {% elif ( (states.sun.sun.attributes.elevation | int < 6.5) and (states.sensor.dark_sky_cloud_coverage.state | int > 85)) %}
          true
          {% elif ( (states.sensor.dark_sky_cloud_coverage.state | int > 70) )  %}
          true
          {% elif ( (states.sensor.dark_sky_cloud_coverage.state | int > 70) and (states.sensor.bad_weather.state == 'rain' ) )  %}
          true
          {% elif ( (states.sensor.dark_sky_cloud_coverage.state | int > 50)
          and ( (states.sensor.bad_weather.state == 'heavy_rain' ) or (states.sensor.bad_weather.state == 'rain' ) ) ) %}
          true
          {% elif (states.sensor.dark_sky_cloud_coverage.state | int > 90) %}
          true
          {% else %}
          false
          {% endif %}

      bad_weather:
        friendly_name: 'Bad weather'
        value_template: >-
          {% if (states.sensor.dark_sky_precip.state == "snow") %}
          snow
          {% elif ((states.sensor.dark_sky_daily_low_temperature.state | int < 4)
          and (states.sensor.dark_sky_dew_point.state | int < 6)
          and (states.sensor.dark_sky_wind_speed.state | int < 12)
          and (states.sensor.dark_sky_cloud_coverage.state | int < 20)
          and (states.sensor.dark_sky_humidity.state | int > 50)) %}
          frost
          {% elif ( (states.sensor.dark_sky_precip.state == "rain")
          and (states.sensor.dark_sky_precip_intensity.state | float > 0.01) ) %}
          rain
          {% elif ( (states.sensor.dark_sky_precip.state == "rain")
          and (states.sensor.dark_sky_precip_intensity.state | int > 1) ) %}
          heavy_rain
          {% else %}
          clear
          {% endif %}


      current_time_float:
        entity_id:
          - sensor.current_time_float
          - date_time.time
        value_template: >-
          {{ (states.sensor.time.state.split(':')[0] | float) + (states.sensor.time.state.split(':')[1] | float / 60) }}
            
      time_of_day:
        friendly_name: 'Time of Day'
        entity_id:
          - sensor.time_of_day
          - sensor.current_time_float
          - sun.sun
        value_template: >-
          {% if ((states.sensor.current_time_float.state | float) > 0) and ((states.sensor.current_time_float.state | float) < 6) %}
          wee_hours
          {% elif ((states.sun.sun.state == 'above_horizon') and ((states.sensor.current_time_float.state | float) < 12.0)) %}
          morning
          {% elif ((states.sun.sun.state == 'above_horizon') and ((states.sensor.current_time_float.state | float) > 12.0)) %}
          afternoon
          {% elif states.sun.sun.state == 'below_horizon' and now().date() == states.sun.sun.attributes.next_rising | truncate(10, True, '') %}
          twilight
          {% elif ((states.sun.sun.state == 'below_horizon') and ((states.sensor.current_time_float.state | float) < 18.0)) %}
          early_evening
          {% elif ((states.sun.sun.state == 'below_horizon') and ((states.sensor.current_time_float.state | float) < 20.5)) %}
          evening
          {% elif ((states.sun.sun.state == 'below_horizon') and ((states.sensor.current_time_float.state | float) >= 20.5)) %}
          late_evening
          {% else %}
          nobody_knows
          {% endif %}

  - platform: yr

    
  - platform: time_date
    display_options:
      - 'time'
      - 'date'
      - 'date_time'
      - 'time_date'
      - 'time_utc'
      - 'beat'
    
  - platform: template
    sensors:
    
      forecast_0:
        friendly_name: Today
        value_template: >
          {{states.sensor.dark_sky_daily_high_temperature.state|round(0)}}°/{{states.sensor.dark_sky_daily_low_temperature.state|round(0)}}°
        icon_template: >-
          {% if is_state("sensor.dark_sky_icon", "clear-day") %}
            mdi:weather-sunny
          {% elif is_state("sensor.dark_sky_icon", "clear-night") %}
            mdi:weather-night
          {% elif is_state("sensor.dark_sky_icon", "cloudy") %}
            mdi:weather-cloudy
          {% elif is_state("sensor.dark_sky_icon", "rain") %}
            mdi:weather-pouring
          {% elif is_state("sensor.dark_sky_icon", "sleet") %}
            mdi:weather-snowy-rain
          {% elif is_state("sensor.dark_sky_icon", "snow") %}
            mdi:weather-snowy
          {% elif is_state("sensor.dark_sky_icon", "wind") %}
            mdi:weather-windy
          {% elif is_state("sensor.dark_sky_icon", "fog") %}
            mdi:weather-fog
          {% elif is_state("sensor.dark_sky_icon", "partly-cloudy-day") %}
            mdi:weather-partlycloudy
          {% elif is_state("sensor.dark_sky_icon", "partly-cloudy-night") %}
            mdi:weather-partlycloudy
          {% else %}
            error
          {% endif %}

      forecast_1:
        friendly_name: Tomorrow
        value_template: >
          {{states.sensor.dark_sky_daily_high_temperature_1.state|round(0)}}°/{{states.sensor.dark_sky_daily_low_temperature_1.state|round(0)}}°
        icon_template: >-
          {% if is_state("sensor.dark_sky_icon_1", "clear-day") %}
            mdi:weather-sunny
          {% elif is_state("sensor.dark_sky_icon_1", "clear-night") %}
            mdi:weather-night
          {% elif is_state("sensor.dark_sky_icon_1", "cloudy") %}
            mdi:weather-cloudy
          {% elif is_state("sensor.dark_sky_icon_1", "rain") %}
            mdi:weather-pouring
          {% elif is_state("sensor.dark_sky_icon_1", "sleet") %}
            mdi:weather-snowy-rain
          {% elif is_state("sensor.dark_sky_icon_1", "snow") %}
            mdi:weather-snowy
          {% elif is_state("sensor.dark_sky_icon_1", "wind") %}
            mdi:weather-windy
          {% elif is_state("sensor.dark_sky_icon_1", "fog") %}
            mdi:weather-fog
          {% elif is_state("sensor.dark_sky_icon_1", "partly-cloudy-day") %}
            mdi:weather-partlycloudy
          {% elif is_state("sensor.dark_sky_icon_1", "partly-cloudy-night") %}
            mdi:weather-partlycloudy
          {% else %}
            error
          {% endif %}

      forecast_2:
        friendly_name_template: >
          {%- set date = as_timestamp(now()) + (2 * 86400 ) -%}
          {{ date | timestamp_custom("%A") }}
        value_template: >
          {{states.sensor.dark_sky_daily_high_temperature_2.state|round(0)}}°/{{states.sensor.dark_sky_daily_low_temperature_2.state|round(0)}}°
        icon_template: >-
          {% if is_state("sensor.dark_sky_icon_2", "clear-day") %}
            mdi:weather-sunny
          {% elif is_state("sensor.dark_sky_icon_2", "clear-night") %}
            mdi:weather-night
          {% elif is_state("sensor.dark_sky_icon_2", "cloudy") %}
            mdi:weather-cloudy
          {% elif is_state("sensor.dark_sky_icon_2", "rain") %}
            mdi:weather-pouring
          {% elif is_state("sensor.dark_sky_icon_2", "sleet") %}
            mdi:weather-snowy-rain
          {% elif is_state("sensor.dark_sky_icon_2", "snow") %}
            mdi:weather-snowy
          {% elif is_state("sensor.dark_sky_icon_2", "wind") %}
            mdi:weather-windy
          {% elif is_state("sensor.dark_sky_icon_2", "fog") %}
            mdi:weather-fog
          {% elif is_state("sensor.dark_sky_icon_2", "partly-cloudy-day") %}
            mdi:weather-partlycloudy
          {% elif is_state("sensor.dark_sky_icon_2", "partly-cloudy-night") %}
            mdi:weather-partlycloudy
          {% else %}
            error
          {% endif %}

      forecast_3:
        friendly_name_template: >
          {%- set date = as_timestamp(now()) + (3 * 86400 ) -%}
          {{ date | timestamp_custom("%A") }}
        value_template: >
          {{states.sensor.dark_sky_daily_high_temperature_3.state|round(0)}}°/{{states.sensor.dark_sky_daily_low_temperature_3.state|round(0)}}°
        icon_template: >-
          {% if is_state("sensor.dark_sky_icon_3", "clear-day") %}
            mdi:weather-sunny
          {% elif is_state("sensor.dark_sky_icon_3", "clear-night") %}
            mdi:weather-night
          {% elif is_state("sensor.dark_sky_icon_3", "cloudy") %}
            mdi:weather-cloudy
          {% elif is_state("sensor.dark_sky_icon_3", "rain") %}
            mdi:weather-pouring
          {% elif is_state("sensor.dark_sky_icon_3", "sleet") %}
            mdi:weather-snowy-rain
          {% elif is_state("sensor.dark_sky_icon_3", "snow") %}
            mdi:weather-snowy
          {% elif is_state("sensor.dark_sky_icon_3", "wind") %}
            mdi:weather-windy
          {% elif is_state("sensor.dark_sky_icon_3", "fog") %}
            mdi:weather-fog
          {% elif is_state("sensor.dark_sky_icon_3", "partly-cloudy-day") %}
            mdi:weather-partlycloudy
          {% elif is_state("sensor.dark_sky_icon_3", "partly-cloudy-night") %}
            mdi:weather-partlycloudy
          {% else %}
            error
          {% endif %}

      forecast_4:
        friendly_name_template: >
          {%- set date = as_timestamp(now()) + (4 * 86400 ) -%}
          {{ date | timestamp_custom("%A") }}
        value_template: >
          {{states.sensor.dark_sky_daily_high_temperature_4.state|round(0)}}°/{{states.sensor.dark_sky_daily_low_temperature_4.state|round(0)}}°
        icon_template: >-
          {% if is_state("sensor.dark_sky_icon_4", "clear-day") %}
            mdi:weather-sunny
          {% elif is_state("sensor.dark_sky_icon_4", "clear-night") %}
            mdi:weather-night
          {% elif is_state("sensor.dark_sky_icon_4", "cloudy") %}
            mdi:weather-cloudy
          {% elif is_state("sensor.dark_sky_icon_4", "rain") %}
            mdi:weather-pouring
          {% elif is_state("sensor.dark_sky_icon_4", "sleet") %}
            mdi:weather-snowy-rain
          {% elif is_state("sensor.dark_sky_icon_4", "snow") %}
            mdi:weather-snowy
          {% elif is_state("sensor.dark_sky_icon_4", "wind") %}
            mdi:weather-windy
          {% elif is_state("sensor.dark_sky_icon_4", "fog") %}
            mdi:weather-fog
          {% elif is_state("sensor.dark_sky_icon_4", "partly-cloudy-day") %}
            mdi:weather-partlycloudy
          {% elif is_state("sensor.dark_sky_icon_4", "partly-cloudy-night") %}
            mdi:weather-partlycloudy
          {% else %}
            error
          {% endif %}

      forecast_5:
        friendly_name_template: >
          {%- set date = as_timestamp(now()) + (5 * 86400 ) -%}
          {{ date | timestamp_custom("%A") }}
        value_template: >
          {{states.sensor.dark_sky_daily_high_temperature_5.state|round(0)}}°/{{states.sensor.dark_sky_daily_low_temperature_5.state|round(0)}}°
        icon_template: >-
          {% if is_state("sensor.dark_sky_icon_5", "clear-day") %}
            mdi:weather-sunny
          {% elif is_state("sensor.dark_sky_icon_5", "clear-night") %}
            mdi:weather-night
          {% elif is_state("sensor.dark_sky_icon_5", "cloudy") %}
            mdi:weather-cloudy
          {% elif is_state("sensor.dark_sky_icon_5", "rain") %}
            mdi:weather-pouring
          {% elif is_state("sensor.dark_sky_icon_5", "sleet") %}
            mdi:weather-snowy-rain
          {% elif is_state("sensor.dark_sky_icon_5", "snow") %}
            mdi:weather-snowy
          {% elif is_state("sensor.dark_sky_icon_5", "wind") %}
            mdi:weather-windy
          {% elif is_state("sensor.dark_sky_icon_5", "fog") %}
            mdi:weather-fog
          {% elif is_state("sensor.dark_sky_icon_5", "partly-cloudy-day") %}
            mdi:weather-partlycloudy
          {% elif is_state("sensor.dark_sky_icon_5", "partly-cloudy-night") %}
            mdi:weather-partlycloudy
          {% else %}
            error
          {% endif %}

      forecast_6:
        friendly_name_template: >
          {%- set date = as_timestamp(now()) + (6 * 86400 ) -%}
          {{ date | timestamp_custom("%A") }}
        value_template: >
          {{states.sensor.dark_sky_daily_high_temperature_6.state|round(0)}}°/{{states.sensor.dark_sky_daily_low_temperature_6.state|round(0)}}°
        icon_template: >-
          {% if is_state("sensor.dark_sky_icon_6", "clear-day") %}
            mdi:weather-sunny
          {% elif is_state("sensor.dark_sky_icon_6", "clear-night") %}
            mdi:weather-night
          {% elif is_state("sensor.dark_sky_icon_6", "cloudy") %}
            mdi:weather-cloudy
          {% elif is_state("sensor.dark_sky_icon_6", "rain") %}
            mdi:weather-pouring
          {% elif is_state("sensor.dark_sky_icon_6", "sleet") %}
            mdi:weather-snowy-rain
          {% elif is_state("sensor.dark_sky_icon_6", "snow") %}
            mdi:weather-snowy
          {% elif is_state("sensor.dark_sky_icon_6", "wind") %}
            mdi:weather-windy
          {% elif is_state("sensor.dark_sky_icon_6", "fog") %}
            mdi:weather-fog
          {% elif is_state("sensor.dark_sky_icon_6", "partly-cloudy-day") %}
            mdi:weather-partlycloudy
          {% elif is_state("sensor.dark_sky_icon_6", "partly-cloudy-night") %}
            mdi:weather-partlycloudy
          {% else %}
            error
          {% endif %}
